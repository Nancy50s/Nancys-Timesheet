<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nancy Mays 50's Cafe Timesheet</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas for screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Courgette&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (Production UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (to compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Custom font classes */
      .font-retro { font-family: 'Bungee Inline', cursive; }
      .font-hand { font-family: 'Courgette', cursive; }
      .font-body { font-family: 'Inter', sans-serif; }
      
      /* Hide number input spinners */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
      
      /* Reset iOS default form styles and ensure transparent backgrounds */
      input, select, textarea {
        -webkit-appearance: none;
        appearance: none;
        border-radius: 0;
        background-color: transparent;
        /* Improve touch handling */
        touch-action: manipulation;
        /* PREVENT AUTO-ZOOM on iOS: Must be at least 16px */
        font-size: 16px !important; 
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      ::-webkit-scrollbar-thumb {
        background: #888; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555; 
      }
      body {
        background-color: #ffffff;
        margin: 0;
        padding: 0;
        overscroll-behavior: none;
        /* Removed overflow-x: hidden to allow scrolling */
        width: 100%;
        position: relative;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
</head>
  <body class="font-body antialiased min-h-screen flex flex-col">
    <div id="root" class="flex-grow"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel">
      const { useState, useCallback, useEffect, useRef, useMemo } = React;

      // --- DATA & CONSTANTS ---
      const DAYS = ['Mon.', 'Tues.', 'Wed.', 'Thurs.', 'Fri.', 'Sat.', 'Sun.'];

      const DAY_MAPPING = {
        'Sun.': 0, 'Mon.': 1, 'Tues.': 2, 'Wed.': 3, 'Thurs.': 4, 'Fri.': 5, 'Sat.': 6
      };
      const FULL_DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      
      // Storage Key for Persistence
      const STORAGE_KEY = 'nancy_mays_timesheet_v1';

      // Generate 15-minute increments: 4:30 AM to 4:30 PM
      const TIME_OPTIONS = [];
      const startMinutes = 4 * 60 + 30; // 4:30 AM
      const endMinutes = 16 * 60 + 30;  // 4:30 PM

      for (let m = startMinutes; m <= endMinutes; m += 15) {
        const h = Math.floor(m / 60);
        const min = m % 60;
        
        const ampm = h >= 12 ? 'PM' : 'AM';
        const hour12 = h % 12 === 0 ? 12 : h % 12;
        const minuteStr = min.toString().padStart(2, '0');
        
        TIME_OPTIONS.push(`${hour12}:${minuteStr} ${ampm}`);
      }

      const generateEmptyRows = () => {
        return Array.from({ length: 14 }).map((_, i) => ({
          id: i,
          day: DAYS[i % 7],
          date: '',
          in1: '',
          out1: '',
          in2: '',
          out2: '',
          break: '',
          hours: '',
          otHours: '',
          sales: '',
          tips: ''
        }));
      };

      // Helper to parse date string into Date object (Noon to avoid timezone shifts)
      const parseDateString = (value) => {
        if (!value) return null;

        // Improved MM/DD/YYYY parsing from dropdown
        if (value.includes('/')) {
           const parts = value.split('/');
           if (parts.length === 3) {
              const m = parseInt(parts[0], 10);
              const d = parseInt(parts[1], 10);
              const y = parseInt(parts[2], 10);
              // Ensure year is fully entered (4 digits) to prevent premature 19xx auto-complete
              if (!isNaN(m) && !isNaN(d) && !isNaN(y) && y > 999) {
                 return new Date(y, m - 1, d, 12, 0, 0);
              }
           }
        }
        
        // Fallbacks
        let match = value.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (match) {
          return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]), 12, 0, 0);
        }
        match = value.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/);
        if (match) {
          return new Date(parseInt(match[3]), parseInt(match[1]) - 1, parseInt(match[2]), 12, 0, 0);
        }

        return null;
      };

      // Helper to convert time string (e.g. "04:30 PM") to total minutes from midnight
      const toMinutes = (timeStr) => {
        if (!timeStr) return null;
        const [time, modifier] = timeStr.split(' ');
        if (!time || !modifier) return null;
        let [h, m] = time.split(':').map(Number);
        if (isNaN(h) || isNaN(m)) return null;
        if (h === 12 && modifier === 'AM') h = 0;
        if (h !== 12 && modifier === 'PM') h += 12;
        return h * 60 + m;
      };

      // Helper to recalculate hours and overtime for ALL rows
      // Applies Daily OT (> 8 hours) AND Weekly OT (Total Hours > 40)
      // CALCULATIONS DONE IN MINUTES TO AVOID FLOATING POINT ERRORS
      const recalculateOvertime = (rows) => {
        let w1TotalMins = 0;
        let w2TotalMins = 0;
        const WEEKLY_LIMIT_MINS = 40 * 60; // 2400 minutes
        const DAILY_LIMIT_MINS = 8 * 60;   // 480 minutes

        return rows.map((row, index) => {
          // Determine if we are in Week 1 (0-6) or Week 2 (7-13)
          const isWeek2 = index >= 7;

          const tIn1 = toMinutes(row.in1);
          const tOut1 = toMinutes(row.out1);
          const tIn2 = toMinutes(row.in2);
          const tOut2 = toMinutes(row.out2);

          let totalMinutes = 0;
          
          if (tIn1 !== null && tOut1 !== null) {
            let diff = tOut1 - tIn1;
            if (diff < 0) diff += 1440; // Handle overnight
            totalMinutes += diff;
          }

          if (tIn2 !== null && tOut2 !== null) {
            let diff = tOut2 - tIn2;
            if (diff < 0) diff += 1440;
            totalMinutes += diff;
          }
          
          if (totalMinutes > 0) {
            // Calculate quota based on TOTAL hours worked so far in the week
            const currentAccum = isWeek2 ? w2TotalMins : w1TotalMins;
            const remainingQuota = Math.max(0, WEEKLY_LIMIT_MINS - currentAccum);
            
            // Determine how many minutes of THIS entry can be Regular.
            // 1. Cannot exceed the daily limit of 8 hours (480 mins).
            // 2. Cannot exceed the remaining 40-hour weekly quota.
            // 3. Obviously cannot exceed total minutes worked today.
            const allowedRegMins = Math.min(totalMinutes, remainingQuota, DAILY_LIMIT_MINS);
            
            const finalRegMins = allowedRegMins;
            const finalOTMins = totalMinutes - finalRegMins;

            // Accumulate TOTAL minutes worked (Reg + OT) for the weekly threshold
            if (isWeek2) {
              w2TotalMins += totalMinutes;
            } else {
              w1TotalMins += totalMinutes;
            }

            return {
              ...row,
              hours: (finalRegMins / 60).toFixed(2),
              otHours: finalOTMins > 0 ? (finalOTMins / 60).toFixed(2) : ''
            };

          } else {
            return {
              ...row,
              hours: '',
              otHours: ''
            };
          }
        });
      };

      // --- COMPONENTS ---

      // Table Row Component
      const TimesheetRow = ({ entry, onChange, timeOptions, validationError, onDismissError, name, isTextMode, autoCorrectWarning, onDismissAutoCorrect }) => {
        const [showSkipWarning, setShowSkipWarning] = useState(false);
        const [showDateWarning, setShowDateWarning] = useState(false);
        const [showNameWarning, setShowNameWarning] = useState(false);
        
        useEffect(() => {
          if (showSkipWarning || showDateWarning || showNameWarning) {
            const handleDismiss = () => {
              setShowSkipWarning(false);
              setShowDateWarning(false);
              setShowNameWarning(false);
            };
            document.addEventListener('click', handleDismiss);
            return () => document.removeEventListener('click', handleDismiss);
          }
        }, [showSkipWarning, showDateWarning, showNameWarning]);

        const inputClass = "w-full h-full bg-transparent text-center focus:outline-none focus:bg-white/50 text-base font-bold font-[Arial] text-gray-800 appearance-none rounded-none";

        const handleChange = (field) => (e) => {
          let val = e.target.value;
          if (field === 'sales' || field === 'tips') {
            const isValidFinancial = /^\$?[0-9]*\.?[0-9]*$/.test(val);
            if (!isValidFinancial) return; 
          }

          // Input Masking for Date in Text Mode (MM/DD/YYYY)
          if (field === 'date' && isTextMode) {
            const prevLen = entry.date ? entry.date.length : 0;
            const currentLen = val.length;

            // Only format if adding characters (typing/pasting), not deleting
            if (currentLen > prevLen) {
                const digits = val.replace(/\D/g, '');
                
                if (digits.length < 2) {
                    val = digits;
                } else if (digits.length >= 2 && digits.length < 4) {
                    val = digits.slice(0, 2) + '/' + digits.slice(2);
                } else if (digits.length >= 4) {
                    val = digits.slice(0, 2) + '/' + digits.slice(2, 4) + '/' + digits.slice(4, 8);
                }
            }
          }

          onChange(entry.id, field, val);
        };

        const handleBlur = (field) => (e) => {
           const val = e.target.value;
           if (!val.trim()) return;
           const num = parseFloat(val.replace(/[^0-9.]/g, ''));
           if (!isNaN(num)) {
             onChange(entry.id, field, `$${num.toFixed(2)}`);
           }
        };

        const handleFixPreviousMonday = () => {
          if (!validationError?.invalidValue) return;
          
          const val = validationError.invalidValue;
          const parts = val.split('/');
          if (parts.length !== 3) return;
          
          const m = parseInt(parts[0], 10);
          const d = parseInt(parts[1], 10);
          const y = parseInt(parts[2], 10);
          
          const date = new Date(y, m - 1, d, 12, 0, 0);
          
          // Calculate days to subtract
          const currentDay = date.getDay(); // 0-6
          let daysToSubtract = (currentDay + 6) % 7;
          if (daysToSubtract === 0) daysToSubtract = 7;
          
          date.setDate(date.getDate() - daysToSubtract);
          
          const mm = String(date.getMonth() + 1).padStart(2, '0');
          const dd = String(date.getDate()).padStart(2, '0');
          const yyyy = date.getFullYear();
          const newDateStr = `${mm}/${dd}/${yyyy}`;
          
          onChange(entry.id, 'date', newDateStr);
          if (onDismissError) onDismissError();
        };

        const getFilteredOptions = (prevTime) => {
          if (!prevTime) return timeOptions;
          const index = timeOptions.indexOf(prevTime);
          return index === -1 ? timeOptions : timeOptions.slice(index + 1);
        };
        
        // Generate valid dates for this row's day of the week
        // Start 2 weeks before current date
        const dateOptions = useMemo(() => {
          const targetDay = DAY_MAPPING[entry.day];
          if (targetDay === undefined) return [];

          const options = [];
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const start = new Date(today);
          start.setDate(today.getDate() - 14);

          const end = new Date(today.getFullYear(), today.getMonth() + 6, 31);

          let current = new Date(start);
          while (current.getDay() !== targetDay) {
            current.setDate(current.getDate() + 1);
          }

          while (current <= end) {
            const mm = String(current.getMonth() + 1).padStart(2, '0');
            const dd = String(current.getDate()).padStart(2, '0');
            const yyyy = current.getFullYear();
            options.push(`${mm}/${dd}/${yyyy}`);
            current.setDate(current.getDate() + 7);
          }
          return options;
        }, [entry.day]);

        const isErrorTarget = validationError && validationError.rowId === entry.id;
        const isAutoCorrectTarget = autoCorrectWarning && autoCorrectWarning.rowId === entry.id;
        const disabledClass = "opacity-50 bg-gray-200 cursor-not-allowed";

        // Row and Column Banding Logic
        // Alternating orange and white rows normally, Purple theme when in Text Mode
        const rowBgClass = isTextMode 
          ? (entry.id % 2 !== 0 ? 'bg-purple-100' : 'bg-purple-50')
          : (entry.id % 2 !== 0 ? 'bg-orange-100' : 'bg-white');
        
        // Column distinct colors (plaid effect with semi-transparent to let row color show)
        const shiftColClass = 'bg-blue-50/50';
        const moneyColClass = 'bg-emerald-50/50';

        return (
          <tr className={`group hover:bg-yellow-200 relative ${rowBgClass} transition-colors duration-75`}>
            <td className="border-r-2 border-b border-black p-0 h-8 bg-gray-100 font-bold text-center text-sm w-10">{entry.id + 1}</td>
            <td className="border-r-2 border-b border-black p-0 h-8 bg-gray-100 font-bold text-center text-sm w-16">{entry.day}</td>
            
            <td className="border-r-2 border-b border-black p-0 h-8 w-32 relative">
              {isTextMode ? (
                <input
                  type="text"
                  className={inputClass}
                  value={entry.date}
                  onChange={handleChange('date')}
                  placeholder="MM/DD/YYYY"
                  maxLength={10}
                />
              ) : (
                <select 
                  className={entry.date ? inputClass : inputClass.replace('text-gray-800', 'text-transparent')}
                  value={entry.date} 
                  onChange={handleChange('date')}
                >
                  <option value="" className="text-gray-800">Delete</option>
                  {dateOptions.map((d) => (
                    <option key={d} value={d} className="text-gray-800">{d}</option>
                  ))}
                </select>
              )}

              {/* Name Warning Overlay - Blocks interaction if name is empty */}
              {(!name || !name.trim()) && (
                 <div
                   className="absolute inset-0 z-20 cursor-pointer"
                   onClick={(e) => {
                     e.stopPropagation();
                     setShowNameWarning(true);
                   }}
                 ></div>
              )}

              {/* Name Warning Popup */}
              {showNameWarning && (
                 <div
                  onClick={() => setShowNameWarning(false)}
                  className="absolute left-0 top-full mt-1 z-50 w-64 bg-white border-4 border-black shadow-xl p-3 text-left origin-top-left animate-in fade-in zoom-in-95 duration-200"
                 >
                   <div className="absolute -top-[10px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-black"></div>
                   <div className="absolute -top-[4px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white"></div>
                   <h4 className="text-red-600 font-bold font-[Arial] uppercase text-xs mb-1 tracking-wider">Name Required!</h4>
                   <p className="text-xs font-[Arial] mb-0 leading-snug text-gray-800 font-medium">Fill out Name before entering date information.</p>
                 </div>
              )}

              {/* Validation Tooltip */}
              {isErrorTarget && (
                <div className="absolute left-0 top-full mt-1 z-50 w-64 bg-white border-4 border-black shadow-xl p-3 text-left origin-top-left animate-in fade-in zoom-in-95 duration-200">
                   <div className="absolute -top-[10px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-black"></div>
                   <div className="absolute -top-[4px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white"></div>
                   <h4 className="text-red-600 font-bold font-[Arial] uppercase text-xs mb-1 tracking-wider">Date Mismatch!</h4>
                   <p className="text-xs font-[Arial] mb-3 leading-snug text-gray-800 font-medium">{validationError.message}</p>
                   <div className="flex gap-2">
                     <button onClick={handleFixPreviousMonday} className="flex-1 bg-blue-100 text-blue-800 text-[10px] font-bold px-1 py-1 border-2 border-black hover:bg-blue-200 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-none transition-all">Previous Monday</button>
                     <button onClick={onDismissError} className="flex-1 bg-red-600 text-white text-[10px] font-bold px-1 py-1 border-2 border-black hover:bg-red-700 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-none transition-all">OK, I'LL FIX IT</button>
                   </div>
                </div>
              )}
              
              {/* Auto-Correct Notification Tooltip */}
              {isAutoCorrectTarget && (
                <div 
                   className="absolute left-0 top-full mt-1 z-50 w-64 bg-white border-4 border-blue-600 shadow-xl p-3 text-left origin-top-left animate-in fade-in zoom-in-95 duration-200 cursor-pointer"
                   onClick={onDismissAutoCorrect}
                >
                   <div className="absolute -top-[10px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-blue-600"></div>
                   <div className="absolute -top-[4px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white"></div>
                   
                   <h4 className="text-blue-600 font-bold font-[Arial] uppercase text-xs mb-1 tracking-wider">Auto-Corrected!</h4>
                   <p className="text-xs font-[Arial] mb-0 leading-snug text-gray-800 font-medium">{autoCorrectWarning.message}</p>
                </div>
              )}
            </td>
            
            <td className={`border-r-2 border-b border-black p-0 h-8 w-28 relative ${shiftColClass}`}>
              {isTextMode ? (
                 <input type="text" className={inputClass} value={entry.in1} onChange={handleChange('in1')} />
              ) : (
                <select className={inputClass} value={entry.in1} onChange={handleChange('in1')}>
                  <option value="">{entry.in1 ? "Delete" : ""}</option>
                  {timeOptions.map((t) => (<option key={t} value={t}>{t}</option>))}
                </select>
              )}
              {!entry.date && (
                <div className="absolute inset-0 z-10 cursor-pointer" onClick={(e) => { e.stopPropagation(); setShowDateWarning(true); }}></div>
              )}
              {showDateWarning && (
                <div onClick={() => setShowDateWarning(false)} className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-50 w-64 bg-white border-4 border-black shadow-xl p-3 text-left origin-bottom animate-in fade-in zoom-in-95 duration-200 cursor-pointer">
                   <div className="absolute -bottom-[10px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-black"></div>
                   <div className="absolute -bottom-[4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-white"></div>
                   <h4 className="text-red-600 font-bold font-[Arial] uppercase text-xs mb-1 tracking-wider">Date Required!</h4>
                   <p className="text-xs font-[Arial] mb-0 leading-snug text-gray-800 font-medium">Please fill out date first.</p>
                </div>
              )}
            </td>

            <td className={`border-r-2 border-b border-black p-0 h-8 w-28 ${shiftColClass}`}>
              {isTextMode ? (
                 <input type="text" className={`${inputClass} ${!entry.in1 ? disabledClass : ''}`} value={entry.out1} onChange={handleChange('out1')} disabled={!entry.in1} />
              ) : (
                <select className={`${inputClass} ${!entry.in1 ? disabledClass : ''}`} value={entry.out1} onChange={handleChange('out1')} disabled={!entry.in1}>
                   <option value="">{entry.out1 ? "Delete" : ""}</option>
                   {getFilteredOptions(entry.in1).map((t) => (<option key={t} value={t}>{t}</option>))}
                </select>
              )}
            </td>
            <td className="border-r-2 border-b border-black p-0 h-8 w-20 bg-gray-100">
              <input type="text" className={inputClass} value={entry.break} readOnly />
            </td>
            <td className={`border-r-2 border-b border-black p-0 h-8 w-28 ${shiftColClass}`}>
              {isTextMode ? (
                 <input type="text" className={`${inputClass} ${!entry.out1 ? disabledClass : ''}`} value={entry.in2} onChange={handleChange('in2')} disabled={!entry.out1} />
              ) : (
                <select className={`${inputClass} ${!entry.out1 ? disabledClass : ''}`} value={entry.in2} onChange={handleChange('in2')} disabled={!entry.out1}>
                   <option value="">{entry.in2 ? "Delete" : ""}</option>
                   {getFilteredOptions(entry.out1).map((t) => (<option key={t} value={t}>{t}</option>))}
                </select>
              )}
            </td>
            
            <td className={`border-r-2 border-b border-black p-0 h-8 w-28 relative ${shiftColClass}`}>
              {isTextMode ? (
                 <input type="text" className={`${inputClass} ${!entry.in2 ? disabledClass : ''}`} value={entry.out2} onChange={handleChange('out2')} disabled={!entry.in2} />
              ) : (
                <select className={`${inputClass} ${!entry.in2 ? disabledClass : ''}`} value={entry.out2} onChange={handleChange('out2')} disabled={!entry.in2}>
                   <option value="">{entry.out2 ? "Delete" : ""}</option>
                   {getFilteredOptions(entry.in2).map((t) => (<option key={t} value={t}>{t}</option>))}
                </select>
              )}
              {!entry.out1 && (
                <div className="absolute inset-0 z-10 cursor-pointer" onClick={(e) => { e.stopPropagation(); setShowSkipWarning(true); }}></div>
              )}
              {showSkipWarning && (
                <div onClick={() => setShowSkipWarning(false)} className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-50 w-64 bg-white border-4 border-black shadow-xl p-3 text-left origin-bottom animate-in fade-in zoom-in-95 duration-200 cursor-pointer">
                   <div className="absolute -bottom-[10px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-black"></div>
                   <div className="absolute -bottom-[4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-white"></div>
                   <h4 className="text-red-600 font-bold font-[Arial] uppercase text-xs mb-1 tracking-wider">Hold on!</h4>
                   <p className="text-xs font-[Arial] mb-0 leading-snug text-gray-800 font-medium">Please fill out your final clock out time on Out - 1 if you haven't taken a break.</p>
                </div>
              )}
            </td>
            
            <td className="border-r-2 border-b border-black p-0 h-8 w-20 bg-amber-100">
              <input type="text" className={inputClass} value={entry.hours} readOnly />
            </td>
            <td className="border-r-2 border-b border-black p-0 h-8 w-20 bg-amber-100">
              <input type="text" className={inputClass} value={entry.otHours} readOnly />
            </td>
            <td className="border-r-2 border-b border-black w-4 bg-stone-200"></td>
            <td className={`border-r-2 border-b border-black p-0 h-8 w-24 ${moneyColClass}`}>
              <input type="text" inputMode="decimal" className={inputClass} value={entry.sales} onChange={handleChange('sales')} onBlur={handleBlur('sales')} />
            </td>
            <td className={`border-b border-black p-0 h-8 w-24 ${moneyColClass}`}>
              <input type="text" inputMode="decimal" className={inputClass} value={entry.tips} onChange={handleChange('tips')} onBlur={handleBlur('tips')} />
            </td>
          </tr>
        );
      };

      const App = () => {
        // Initialize state from localStorage if available
        const [name, setName] = useState(() => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              return parsed.name || '';
            }
          } catch (e) {
            console.error("Failed to load name from cache", e);
          }
          return '';
        });
        
        // Initialize periodEnding
        const [periodEnding, setPeriodEnding] = useState(() => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (parsed.periodEnding) return parsed.periodEnding;
            }
          } catch (e) {}
          return '';
        });

        const [rows, setRows] = useState(() => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (parsed.rows) return parsed.rows;
            }
          } catch (e) {
            console.error("Failed to load rows from cache", e);
          }
          return generateEmptyRows();
        });
        
        // Footer Totals
        const [regHours, setRegHours] = useState('');
        const [otHoursTotal, setOtHoursTotal] = useState('');
        const [combinedHours, setCombinedHours] = useState(''); // New Combined Total State
        const [totalSales, setTotalSales] = useState('');
        const [totalTips, setTotalTips] = useState('');

        // Week 1 Totals
        const [week1Totals, setWeek1Totals] = useState({
          reg: '',
          ot: '',
          sales: '',
          tips: ''
        });

        // Week 2 Totals
        const [week2Totals, setWeek2Totals] = useState({
          reg: '',
          ot: '',
          sales: '',
          tips: ''
        });

        // Validation & Modal State
        const [validationError, setValidationError] = useState(null);
        const [autoCorrectWarning, setAutoCorrectWarning] = useState(null);
        const [showPeriodWarning, setShowPeriodWarning] = useState(false);

        const [showConfirmReset, setShowConfirmReset] = useState(false);
        
        // Save feedback state
        const [isCopying, setIsCopying] = useState(false);
        const [isAutoSaving, setIsAutoSaving] = useState(false);

        // Text Entry Mode State
        const [isTextMode, setIsTextMode] = useState(false);
        
        // Ref for capturing screenshot
        const timesheetRef = useRef(null);
        const isFirstRender = useRef(true);

        // --- Effects ---

        // Persistence Effect
        useEffect(() => {
          if (isFirstRender.current) {
            isFirstRender.current = false;
            return;
          }

          try {
            const dataToSave = {
              name,
              rows,
              periodEnding
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            
            // Trigger Auto Save Popup
            setIsAutoSaving(true);
            const timer = setTimeout(() => setIsAutoSaving(false), 800); 
            return () => clearTimeout(timer);

          } catch (e) {
            console.error("Failed to save to cache", e);
          }
        }, [name, rows, periodEnding]);

        // Auto-update Pay Period Ending based on the last entered date
        useEffect(() => {
          // Priority: If Row 14 (index 13) has a date, that IS the Period Ending date.
          if (rows[13] && rows[13].date) {
             setPeriodEnding(rows[13].date);
             return;
          }

          const rowsWithDates = rows.filter(r => r.date && r.date.trim() !== '');
          if (rowsWithDates.length > 0) {
            // Get the last row that has a date
            const lastDate = rowsWithDates[rowsWithDates.length - 1].date;
            setPeriodEnding(lastDate);
          } else {
            setPeriodEnding('');
          }
        }, [rows]);

        // Handle outside clicks for period warning
        useEffect(() => {
          if (showPeriodWarning) {
            const handleDismiss = () => setShowPeriodWarning(false);
            document.addEventListener('click', handleDismiss);
            return () => document.removeEventListener('click', handleDismiss);
          }
        }, [showPeriodWarning]);

        // Helper to calculate totals locally
        const calculateTotals = useCallback(() => {
          let h = 0;
          let ot = 0;
          let s = 0;
          let t = 0;

          // Week 1 accumulators
          let w1h = 0;
          let w1ot = 0;
          let w1s = 0;
          let w1t = 0;

          // Week 2 accumulators
          let w2h = 0;
          let w2ot = 0;
          let w2s = 0;
          let w2t = 0;
          
          rows.forEach((r, index) => {
            // Sum Hours
            const valH = parseFloat(r.hours);
            const valHNum = !isNaN(valH) ? valH : 0;
            h += valHNum;
            
            // Sum OT Hours
            const valOT = parseFloat(r.otHours);
            const valOTNum = !isNaN(valOT) ? valOT : 0;
            ot += valOTNum;

            // Sum Sales
            const cleanSales = r.sales.replace(/[^0-9.-]+/g, '');
            const valS = parseFloat(cleanSales);
            const valSNum = !isNaN(valS) ? valS : 0;
            s += valSNum;

            // Sum Tips
            const cleanTips = r.tips.replace(/[^0-9.-]+/g, '');
            const valT = parseFloat(cleanTips);
            const valTNum = !isNaN(valT) ? valT : 0;
            t += valTNum;

            // Accumulate Week 1 (Indices 0-6)
            if (index < 7) {
              w1h += valHNum;
              w1ot += valOTNum;
              w1s += valSNum;
              w1t += valTNum;
            } else {
              // Accumulate Week 2 (Indices 7-13)
              w2h += valHNum;
              w2ot += valOTNum;
              w2s += valSNum;
              w2t += valTNum;
            }
          });

          setRegHours(h.toFixed(2));
          setOtHoursTotal(ot.toFixed(2));
          setCombinedHours((h + ot).toFixed(2)); // Calculate Combined Total
          setTotalSales('$' + s.toFixed(2));
          setTotalTips('$' + t.toFixed(2));

          setWeek1Totals({
            reg: w1h.toFixed(2),
            ot: w1ot.toFixed(2),
            sales: '$' + w1s.toFixed(2),
            tips: '$' + w1t.toFixed(2)
          });

          setWeek2Totals({
            reg: w2h.toFixed(2),
            ot: w2ot.toFixed(2),
            sales: '$' + w2s.toFixed(2),
            tips: '$' + w2t.toFixed(2)
          });
        }, [rows]);

        useEffect(() => {
          calculateTotals();
        }, [rows, calculateTotals]);

        // --- Actions ---
        
        const handleCopyScreenshot = async () => {
          if (!timesheetRef.current) return;
          setIsCopying(true);
          
          try {
            // html2canvas is loaded globally via script tag
            // IMPORTANT: Removed type annotation (element: Element) to fix Syntax Error
            const canvas = await html2canvas(timesheetRef.current, {
               scale: 2, 
               useCORS: true,
               backgroundColor: '#ffffff',
               ignoreElements: (element) => element.classList.contains('no-screenshot') 
            });
            
            canvas.toBlob(async (blob) => {
               if (blob) {
                 const safeName = name.replace(/[^a-zA-Z0-9]/g, '_') || 'Export';
                 const safeDate = periodEnding ? `_${periodEnding.replace(/[^a-zA-Z0-9]/g, '-')}` : '';
                 const fileName = `Timesheet_${safeName}${safeDate}.png`;
                 const file = new File([blob], fileName, { type: 'image/png' });

                 // 1. Try Web Share API (Mobile)
                 if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                      await navigator.share({
                        files: [file],
                        title: 'Nancy Mays Timesheet',
                      });
                      setIsCopying(false);
                      return;
                    } catch (err) {
                      if (err.name === 'AbortError') {
                         setIsCopying(false);
                         return;
                      }
                      console.warn("Share API failed, falling back", err);
                    }
                 }

                 // 2. Fallback to Clipboard (Desktop)
                 try {
                   if (navigator.clipboard && navigator.clipboard.write) {
                     await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                     ]);
                     setTimeout(() => setIsCopying(false), 2000);
                     return;
                   }
                 } catch (err) {
                   console.warn("Clipboard write failed", err);
                 }
                 
                 // 3. Fallback to Download
                 const url = URL.createObjectURL(blob);
                 const link = document.createElement('a');
                 link.href = url;
                 link.download = fileName;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 URL.revokeObjectURL(url);
                 setTimeout(() => setIsCopying(false), 2000);
               }
            });
          } catch (e) {
             console.error("Screenshot failed", e);
             setIsCopying(false);
             alert("Failed to generate image.");
          }
        };

        const requestReset = () => {
          setShowConfirmReset(true);
        };

        const performReset = () => {
          setRows(generateEmptyRows());
          setName('');
          setPeriodEnding('');
          setShowConfirmReset(false);
          setValidationError(null);
          setAutoCorrectWarning(null);
          setShowPeriodWarning(false);
          setIsTextMode(false); // Reset to dropdown mode
        };

        const dismissError = () => {
          setValidationError(null);
        };

        const dismissAutoCorrect = () => {
          setAutoCorrectWarning(null);
        };

        const handlePeriodClick = (e) => {
          e.stopPropagation();
          const hasDates = rows.some(r => r.date && r.date.trim() !== '');
          if (!hasDates) {
            setShowPeriodWarning(true);
          }
        };

        const handleRowChange = (id, field, value) => {
          const numericId = Number(id);
          let finalValue = value;

          // --- VALIDATION LOGIC ---
          if (field === 'date' && value !== '') {
            const targetRow = rows.find(r => r.id === numericId);
            if (targetRow) {
              const dateObj = parseDateString(value);
              
              if (dateObj) {
                  const actualDayIndex = dateObj.getDay();
                  const expectedDayIndex = DAY_MAPPING[targetRow.day];

                  if (actualDayIndex !== expectedDayIndex) {
                    
                    // AUTO-CORRECTION LOGIC FOR MONDAY IN TEXT MODE
                    if (isTextMode && targetRow.day === 'Mon.') {
                        // Calculate days to subtract to reach previous Monday
                        let daysToSubtract = (actualDayIndex + 6) % 7;
                        if (daysToSubtract === 0) daysToSubtract = 7; 
                        
                        const correctedDate = new Date(dateObj);
                        correctedDate.setDate(dateObj.getDate() - daysToSubtract);
                        
                        const mm = String(correctedDate.getMonth() + 1).padStart(2, '0');
                        const dd = String(correctedDate.getDate()).padStart(2, '0');
                        const yyyy = correctedDate.getFullYear();
                        const correctedDateStr = `${mm}/${dd}/${yyyy}`;
                        
                        finalValue = correctedDateStr;
                        
                        setAutoCorrectWarning({
                          rowId: numericId,
                          message: `Date adjusted to previous Monday (${correctedDateStr}) to maintain weekly schedule.`
                        });
                        
                        if (validationError && validationError.rowId === numericId) setValidationError(null);

                    } else {
                      // Strict validation error
                      setValidationError({
                        rowId: numericId,
                        message: `${value} is a ${FULL_DAY_NAMES[actualDayIndex]}, but this row is for ${targetRow.day}`,
                        invalidValue: value
                      });
                      return; 
                    }
                  } else {
                    // Valid date entered
                    if (validationError && validationError.rowId === numericId) {
                      setValidationError(null);
                    }
                    if (autoCorrectWarning && autoCorrectWarning.rowId === numericId) {
                      setAutoCorrectWarning(null);
                    }
                  }
              }
            }
          }

          setRows(prev => {
            // 1. First, apply the input change and simple intra-row logic (Break, Date cascading)
            // We will map to a temporary array first
            const isDateCascade = field === 'date' && finalValue !== '';
            
            let anchorDate = null;
            if (isDateCascade) {
              const inputDate = parseDateString(finalValue);
              if (inputDate) {
                 anchorDate = new Date(inputDate);
                 anchorDate.setDate(anchorDate.getDate() - numericId);
              }
            }

            const tempRows = prev.map(row => {
              const updatedRow = { ...row };

              // Apply Value to Target
              if (row.id === numericId) {
                if (field !== 'id') {
                  updatedRow[field] = finalValue;
                }
              }

              // Apply Date Cascade
              if (isDateCascade && anchorDate) {
                const rowDate = new Date(anchorDate);
                rowDate.setDate(anchorDate.getDate() + row.id);
                
                const yyyy = rowDate.getFullYear();
                const mm = String(rowDate.getMonth() + 1).padStart(2, '0');
                const dd = String(rowDate.getDate()).padStart(2, '0');
                updatedRow.date = `${mm}/${dd}/${yyyy}`;
              }

              // Intra-row Logic: Calculate Break Time Display
              // Note: We are NO LONGER calculating hours/otHours here. That happens in step 2.
              if (row.id === numericId && ['in1', 'out1', 'in2', 'out2'].includes(field)) {
                
                const tOut1 = toMinutes(updatedRow.out1);
                const tIn2 = toMinutes(updatedRow.in2);

                if (tOut1 !== null && tIn2 !== null) {
                  let breakDiff = tIn2 - tOut1;
                  if (breakDiff > 0) {
                     const h = Math.floor(breakDiff / 60);
                     const m = breakDiff % 60;
                     updatedRow.break = `${h}:${m.toString().padStart(2, '0')}`;
                  } else {
                    updatedRow.break = '';
                  }
                } else {
                   if (field === 'out1' || field === 'in2') {
                     updatedRow.break = '';
                   }
                }
              }

              return updatedRow;
            });

            // 2. Second, run the comprehensive Overtime Calculation on the full dataset
            // This ensures that changes in row 1 affect row 5's Weekly Overtime status if needed.
            return recalculateOvertime(tempRows);
          });
        };

        const totalInputClass = "w-full h-full bg-transparent text-center focus:outline-none text-base font-bold font-[Arial] text-gray-800 appearance-none rounded-none";
        const headerBgClass = isTextMode ? 'bg-yellow-100' : '';
        
        return (
          <div className="min-h-screen bg-white flex flex-col w-full overflow-x-auto">
            
            <div ref={timesheetRef} className="bg-white relative shrink-0 w-max max-w-none inline-block px-4 pt-2 mx-auto pb-20">
              
              {/* ACTION BUTTONS (TOP LEFT) */}
              <div className="absolute top-2 left-2 z-20 flex flex-col items-start print:hidden no-screenshot">
                
                <div className="flex flex-row gap-2">
                  <button 
                    onClick={handleCopyScreenshot} 
                    className="text-xs font-bold text-cyan-600 border-2 border-cyan-600 px-3 py-2 hover:bg-cyan-50 rounded uppercase tracking-wider bg-white min-w-[80px]" 
                    title="Save image to photos or clipboard"
                  >
                    {isCopying ? 'Copied!' : 'COPY IMAGE'}
                  </button>
                  <button 
                    onClick={() => setIsTextMode(!isTextMode)} 
                    className={`text-xs font-bold border-2 px-3 py-2 rounded uppercase tracking-wider bg-white min-w-[80px] ${
                      isTextMode 
                        ? 'text-purple-600 border-purple-600 hover:bg-purple-50' 
                        : 'text-blue-600 border-blue-600 hover:bg-blue-50'
                    }`}
                    title="Toggle between dropdown and text input"
                  >
                    {isTextMode ? 'Dropdown Mode' : 'Text Entry Mode'}
                  </button>
                  <button 
                    onClick={requestReset} 
                    className="text-xs font-bold text-red-600 border-2 border-red-600 px-3 py-2 hover:bg-red-50 rounded uppercase tracking-wider bg-white min-w-[80px]" 
                    title="Delete all data and reset form"
                  >
                    Clear Form
                  </button>
                </div>

                {showConfirmReset && (
                  <div className="mt-2 w-64 bg-white border-4 border-black shadow-xl p-3 text-center relative self-end">
                     <div className="absolute -top-1 -left-1 w-full h-full bg-red-100 -z-10 border-4 border-black hidden sm:block"></div>
                     
                     <div className="absolute top-[-10px] right-4 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-black"></div>
                     <div className="absolute top-[-4px] right-4 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white"></div>
                     
                     <h4 className="text-red-600 font-bold font-[Arial] uppercase text-sm mb-2 tracking-wider">Wait a sec!</h4>
                     <p className="text-xs font-[Arial] mb-3 leading-snug text-gray-800 font-medium">
                        Are you sure you want to clear the form? This will delete all your hard work.
                     </p>
                     <div className="flex justify-center gap-2">
                        <button onClick={() => setShowConfirmReset(false)} className="bg-gray-200 hover:bg-gray-300 text-black border-2 border-black font-bold py-1 px-3 text-xs shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-1 transition-all">Cancel</button>
                        <button onClick={performReset} className="bg-red-600 hover:bg-red-700 text-white border-2 border-black font-bold py-1 px-3 text-xs shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-1 transition-all">Yes, Clear</button>
                     </div>
                  </div>
                )}
              </div>

              <div className="mt-16 mb-6">
                <h1 className="text-xl font-black text-left uppercase tracking-widest font-[Arial] text-black leading-none">NANCY MAY'S 50'S CAFE</h1>
                <h2 className="text-xl font-black text-left uppercase tracking-widest font-[Arial] text-black leading-none mt-1">TIME SHEET</h2>
              </div>

              {/* --- HEADER --- */}
              <div className="flex flex-row justify-between items-end mb-6 gap-8 mt-0 px-2">
                <div className="flex-1 flex flex-row items-end mr-4">
                  <span className="text-xl font-bold mr-2 whitespace-nowrap">Name:</span>
                  <input type="text" value={name} onChange={(e) => setName(e.target.value)} autoComplete="off" className="w-full border-b-4 border-black text-2xl font-bold font-[Arial] px-2 bg-transparent focus:bg-transparent focus:outline-none rounded-none appearance-none"/>
                </div>
                <div className="flex-1 flex flex-row items-end relative">
                  <span className="text-xl font-bold mr-2 whitespace-nowrap">Pay Period Ending:</span>
                  <div className="relative w-full flex items-center" onClick={handlePeriodClick}>
                    
                    <input 
                      type="text" 
                      value={periodEnding} 
                      readOnly
                      placeholder="MM/DD/YYYY"
                      className="w-full border-b-4 border-black text-2xl font-bold font-[Arial] px-2 bg-transparent focus:outline-none text-center rounded-none appearance-none cursor-pointer"
                    />

                    {showPeriodWarning && (
                      <div className="absolute top-full left-0 mt-2 z-50 w-64 bg-white border-4 border-black shadow-xl p-3 text-left origin-top-left animate-in fade-in zoom-in-95 duration-200 cursor-pointer">
                         <div className="absolute -top-[10px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-black"></div>
                         <div className="absolute -top-[4px] left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white"></div>
                         <h4 className="text-red-600 font-bold font-[Arial] uppercase text-xs mb-1 tracking-wider">Dates Missing!</h4>
                         <p className="text-xs font-[Arial] mb-0 leading-snug text-gray-800 font-medium">Enter the dates in the spreadsheet first.</p>
                      </div>
                    )}
                    
                  </div>
                </div>
              </div>

              {/* --- MAIN CONTENT GRID --- */}
              <div className="flex flex-col border-t-4 border-black pt-2 md:pt-0">
                <div className="">
                  <table className="border-collapse table-fixed w-max">
                    <thead>
                      <tr>
                        <th className={`border-r-2 border-b-4 border-black text-center py-1 w-10 ${headerBgClass}`}>No.</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-16 ${headerBgClass}`}>Day</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-32 ${headerBgClass}`}>Date</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-28 ${headerBgClass}`}>In - 1</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-28 ${headerBgClass}`}>Out - 1</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-20 ${headerBgClass}`}>Break</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-28 ${headerBgClass}`}>In - 2</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-28 ${headerBgClass}`}>Out - 2</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-20 ${headerBgClass}`}>Hours</th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-20 ${headerBgClass}`}>O.T. Hours</th>
                        <th className="border-r-2 border-b-4 border-black w-4 bg-stone-200"></th>
                        <th className={`border-r-2 border-b-4 border-black text-left pl-2 py-1 w-24 ${headerBgClass}`}>Sales</th>
                        <th className={`border-b-4 border-black text-left pl-2 py-1 w-24 ${headerBgClass}`}>Tips</th>
                      </tr>
                    </thead>
                    <tbody>
                      {/* FIRST WEEK (Rows 0-6) */}
                      {rows.slice(0, 7).map((row) => (
                        <TimesheetRow 
                          key={row.id} 
                          entry={row} 
                          onChange={handleRowChange} 
                          timeOptions={TIME_OPTIONS} 
                          validationError={validationError?.rowId === row.id ? validationError : null}
                          onDismissError={dismissError}
                          name={name}
                          isTextMode={isTextMode}
                          autoCorrectWarning={autoCorrectWarning?.rowId === row.id ? autoCorrectWarning : null}
                          onDismissAutoCorrect={dismissAutoCorrect}
                        />
                      ))}

                      {/* WEEK 1 TOTALS ROW */}
                      <tr className="bg-gray-50 border-t-2 border-black">
                        <td colSpan={8} className="border-r-2 border-b-4 border-black text-right p-2 font-bold text-sm align-middle bg-gray-100">Week 1 Totals:</td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week1Totals.reg} readOnly /></td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week1Totals.ot} readOnly /></td>
                        <td className="border-r-2 border-b-4 border-black bg-stone-200"></td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week1Totals.sales} readOnly /></td>
                        <td className="border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week1Totals.tips} readOnly /></td>
                      </tr>

                      {/* SPACER ROW to visually separate weeks */}
                      <tr>
                         <td colSpan={13} className="h-4 bg-stone-200 border-x-4 border-black border-b-4"></td>
                      </tr>

                      {/* SECOND WEEK (Rows 7-13) */}
                      {rows.slice(7).map((row) => (
                        <TimesheetRow 
                          key={row.id} 
                          entry={row} 
                          onChange={handleRowChange} 
                          timeOptions={TIME_OPTIONS} 
                          validationError={validationError?.rowId === row.id ? validationError : null}
                          onDismissError={dismissError}
                          name={name}
                          isTextMode={isTextMode}
                          autoCorrectWarning={autoCorrectWarning?.rowId === row.id ? autoCorrectWarning : null}
                          onDismissAutoCorrect={dismissAutoCorrect}
                        />
                      ))}

                      {/* WEEK 2 TOTALS ROW */}
                      <tr className="bg-gray-50 border-t-2 border-black">
                        <td colSpan={8} className="border-r-2 border-b-4 border-black text-right p-2 font-bold text-sm align-middle bg-gray-100">Week 2 Totals:</td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week2Totals.reg} readOnly /></td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week2Totals.ot} readOnly /></td>
                        <td className="border-r-2 border-b-4 border-black bg-stone-200"></td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week2Totals.sales} readOnly /></td>
                        <td className="border-b-4 border-black p-0 h-8 bg-gray-100"><input className={totalInputClass} value={week2Totals.tips} readOnly /></td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colSpan={8} className="border-r-2 border-b-4 border-black text-right p-2 font-bold text-sm align-middle">Grand Totals:</td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-10 bg-yellow-50/30"><input className={totalInputClass} value={regHours} readOnly /></td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-10 bg-yellow-50/30"><input className={totalInputClass} value={otHoursTotal} readOnly /></td>
                        <td className="border-r-2 border-b-4 border-black bg-stone-200"></td>
                        <td className="border-r-2 border-b-4 border-black p-0 h-10"><input className={totalInputClass} value={totalSales} readOnly /></td>
                        <td className="border-b-4 border-black p-0 h-10"><input className={totalInputClass} value={totalTips} readOnly /></td>
                      </tr>
                      {/* NEW ROW for Combined Total */}
                      <tr>
                        <td colSpan={8} className="border-r-2 border-b-4 border-black text-right p-2 font-bold text-sm align-middle">Total Hrs + O.T.:</td>
                        <td colSpan={2} className="border-r-2 border-b-4 border-black p-0 h-10 bg-yellow-100">
                           <input className={totalInputClass} value={combinedHours} readOnly />
                        </td>
                        <td className="border-r-2 border-b-4 border-black bg-stone-200"></td>
                        <td colSpan={2} className="border-b-4 border-black bg-white"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              {/* ACTION BUTTONS (BOTTOM RIGHT) - DUPLICATED */}
              <div className="absolute bottom-2 right-2 z-20 flex flex-col items-end print:hidden no-screenshot">
                {showConfirmReset && (
                  <div className="mb-2 w-64 bg-white border-4 border-black shadow-xl p-3 text-center relative">
                     <div className="absolute -top-1 -left-1 w-full h-full bg-red-100 -z-10 border-4 border-black hidden sm:block"></div>
                     <div className="absolute -bottom-[10px] right-4 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-black"></div>
                     <div className="absolute -bottom-[4px] right-4 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-white"></div>
                     
                     <h4 className="text-red-600 font-bold font-[Arial] uppercase text-sm mb-2 tracking-wider">Wait a sec!</h4>
                     <p className="text-xs font-[Arial] mb-3 leading-snug text-gray-800 font-medium">
                        Are you sure you want to clear the form? This will delete all your hard work.
                     </p>
                     <div className="flex justify-center gap-2">
                        <button onClick={() => setShowConfirmReset(false)} className="bg-gray-200 hover:bg-gray-300 text-black border-2 border-black font-bold py-1 px-3 text-xs shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-1 transition-all">Cancel</button>
                        <button onClick={performReset} className="bg-red-600 hover:bg-red-700 text-white border-2 border-black font-bold py-1 px-3 text-xs shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-1 transition-all">Yes, Clear</button>
                     </div>
                  </div>
                )}
                
                <div className="flex flex-row gap-2">
                  <button 
                    onClick={handleCopyScreenshot} 
                    className="text-xs font-bold text-cyan-600 border-2 border-cyan-600 px-3 py-2 hover:bg-cyan-50 rounded uppercase tracking-wider bg-white min-w-[80px]" 
                    title="Save image to photos or clipboard"
                  >
                    {isCopying ? 'Copied!' : 'COPY IMAGE'}
                  </button>
                  <button 
                    onClick={() => setIsTextMode(!isTextMode)} 
                    className={`text-xs font-bold border-2 px-3 py-2 rounded uppercase tracking-wider bg-white min-w-[80px] ${
                      isTextMode 
                        ? 'text-purple-600 border-purple-600 hover:bg-purple-50' 
                        : 'text-blue-600 border-blue-600 hover:bg-blue-50'
                    }`}
                    title="Toggle between dropdown and text input"
                  >
                    {isTextMode ? 'Dropdown Mode' : 'Text Entry Mode'}
                  </button>
                  <button 
                    onClick={requestReset} 
                    className="text-xs font-bold text-red-600 border-2 border-red-600 px-3 py-2 hover:bg-red-50 rounded uppercase tracking-wider bg-white min-w-[80px]" 
                    title="Delete all data and reset form"
                  >
                    Clear Form
                  </button>
                </div>
              </div>

            </div>

            {isAutoSaving && (
               <div className="fixed bottom-4 right-4 z-50 bg-white border-2 border-black px-4 py-2 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] animate-in slide-in-from-bottom-2 fade-in duration-300 pointer-events-none">
                  <div className="flex items-center gap-3">
                     <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                     <span className="text-xs font-black font-[Arial] uppercase tracking-widest text-black">Auto Saving...</span>
                  </div>
               </div>
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>